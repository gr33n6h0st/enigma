<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ULTRA | ENIGMA M3 SIMULATOR</title>
    <style>
        body {
            background-color: #121212;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            font-family: 'Courier New', Courier, monospace;
            color: #d4d4d4;
        }

        /* The Main Chassis - Dark Metal/Steel */
        .machine-body {
            width: 700px;
            background: #1a1a1a;
            border: 12px solid #222;
            border-bottom: 20px solid #1a1a1a;
            border-radius: 4px;
            box-shadow: 0 50px 100px rgba(0,0,0,0.9), inset 0 0 40px #000;
            padding: 40px;
        }

        /* Rotor Windows - Recessed into the metal */
        .rotor-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            padding: 10px;
            background: #000;
            border: 2px inset #333;
            width: fit-content;
            margin-inline: auto;
        }

        .rotor {
            width: 45px;
            height: 60px;
            background: #e0e0e0;
            color: #000;
            font-size: 2rem;
            font-weight: 900;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 2px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }

        /* Lampboard - The glowing letters */
        .lampboard {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 12px;
            margin-bottom: 40px;
            padding: 20px;
            background: #111;
            border-radius: 8px;
            box-shadow: inset 0 0 20px #000;
        }

        .lamp {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #222;
            border: 2px solid #333;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: #444;
            transition: 0.05s;
        }

        .lamp.on {
            background: #fffbe6;
            color: #000;
            box-shadow: 0 0 25px 5px #fff;
            border-color: #fff;
        }

        /* Keys - High contrast black with white text */
        .keyboard {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 12px;
        }

        .key {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #000;
            border: 2px solid #555;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 0 #000;
            transition: 0.05s;
        }

        .key:active {
            transform: translateY(4px);
            box-shadow: 0 1px 0 #000;
        }

        /* The Paper Output Tape */
        .tape-output {
            background: #dcd0b0;
            color: #222;
            padding: 15px;
            margin-top: 30px;
            font-weight: bold;
            letter-spacing: 2px;
            min-height: 25px;
            border-left: 10px solid #b1a27e;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.4);
            word-break: break-all;
        }

        .label {
            font-size: 0.7rem;
            color: #555;
            text-align: center;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
    </style>
</head>
<body>

    <div class="machine-body">
        <div class="label">Rotor Settings</div>
        <div class="rotor-container">
            <div class="rotor" id="r-val">00</div>
        </div>

        <div class="label">Output Lampboard</div>
        <div class="lampboard" id="lb"></div>

        <div class="label">Input Keyboard</div>
        <div class="keyboard" id="kb"></div>

        <div class="tape-output" id="tape">>> </div>
        
        <div class="label" style="margin-top: 20px;">Use physical keyboard | BACKSPACE to reset</div>
    </div>

<script>
    // Authentic M3 Rotor I and Reflector B wiring
    const alphabet = "QWERTZUIOASDFGHJKPYXCVBNM".split(""); // Traditional Layout
    const alphaMap = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    const rotorWiring = "EKMFLGDQVZNTOWYHXUSPAIBRCJ";
    const reflector = "YRUHQSLDPXNGOKMIEBFZCWVJAT";
    
    let rotorPos = 0;

    const lb = document.getElementById('lb');
    const kb = document.getElementById('kb');
    const tape = document.getElementById('tape');
    const rotorDisp = document.getElementById('r-val');

    // Create the UI components
    alphabet.forEach(char => {
        lb.innerHTML += `<div class="lamp" id="L-${char}">${char}</div>`;
        kb.innerHTML += `<div class="key" id="K-${char}">${char}</div>`;
    });

    function encrypt(char) {
        let idx = alphaMap.indexOf(char);
        if (idx === -1) return null;

        // 1. Rotor Forward
        let shift = (idx + rotorPos) % 26;
        let forward = rotorWiring[shift];
        
        // 2. Reflector
        let refIdx = alphaMap.indexOf(forward);
        let reflected = reflector[refIdx];
        
        // 3. Rotor Reverse
        let revIdx = rotorWiring.indexOf(reflected);
        let finalIdx = (revIdx - rotorPos + 26) % 26;
        
        return alphaMap[finalIdx];
    }

    window.addEventListener('keydown', (e) => {
        const key = e.key.toUpperCase();
        
        if (key === "BACKSPACE") {
            tape.innerText = ">> ";
            rotorPos = 0;
            rotorDisp.innerText = "00";
            return;
        }

        if (alphaMap.includes(key)) {
            const result = encrypt(key);
            
            // Light the lamp
            document.querySelectorAll('.lamp').forEach(l => l.classList.remove('on'));
            const lamp = document.getElementById(`L-${result}`);
            if (lamp) lamp.classList.add('on');

            // Update paper tape
            tape.innerText += result;
            
            // Step the rotor
            rotorPos = (rotorPos + 1) % 26;
            rotorDisp.innerText = rotorPos.toString().padStart(2, '0');
        }
    });
</script>
</body>
</html>

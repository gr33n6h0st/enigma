<!DOCTYPE html>
<html>
<head>
    <title>ENIGMA M3 | FINAL REPAIR</title>
    <style>
        body { background: #111; color: white; font-family: monospace; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .tape { background: white; color: black; width: 600px; padding: 15px; font-size: 24px; font-weight: bold; margin-bottom: 20px; border: 4px solid #b8860b; min-height: 1.5em; overflow-wrap: break-word; }
        .rotor-display { display: flex; gap: 10px; margin-bottom: 20px; }
        .rotor { width: 60px; height: 80px; background: #333; border: 2px solid gold; display: flex; justify-content: center; align-items: center; font-size: 40px; color: gold; }
        .keyboard { display: grid; grid-template-columns: repeat(9, 1fr); gap: 10px; background: #222; padding: 20px; border-radius: 10px; }
        .key { width: 40px; height: 40px; border: 1px solid #555; display: flex; justify-content: center; align-items: center; background: #000; cursor: pointer; }
        .key.active { background: white; color: black; box-shadow: 0 0 15px white; }
        .controls { margin-top: 20px; }
        button { padding: 10px 20px; background: red; color: white; border: none; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div class="tape" id="tape">>> </div>

    <div class="rotor-display">
        <div class="rotor" id="r2">A</div>
        <div class="rotor" id="r1">A</div>
        <div class="rotor" id="r0">A</div>
    </div>

    <div class="keyboard" id="kb"></div>

    <div class="controls">
        <button onclick="resetAll()">RESET MACHINE</button>
    </div>

<script>
    const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    const kbLayout = "QWERTZUIOASDFGHJKPYXCVBNM".split("");
    const rotorI =   "EKMFLGDQVZNTOWYHXUSPAIBRCJ"; // Wiring for Rotor I
    const reflectorB = "YRUHQSLDPXNGOKMIEBFZCWVJAT"; // Wiring for Reflector B

    let pos = [0, 0, 0]; // [Right, Middle, Left] offsets

    // Initialize Keyboard UI
    kbLayout.forEach(char => {
        document.getElementById('kb').innerHTML += `<div class="key" id="K-${char}">${char}</div>`;
    });

    function resetAll() {
        pos = [0, 0, 0];
        document.getElementById('tape').innerText = ">> ";
        updateUI();
    }

    function updateUI() {
        pos.forEach((p, i) => {
            document.getElementById(`r${i}`).innerText = alphabet[p];
        });
    }

    function enigma(char) {
        // 1. Step the right rotor first
        pos[0] = (pos[0] + 1) % 26;
        if (pos[0] === 0) pos[1] = (pos[1] + 1) % 26;
        updateUI();

        // 2. Map through rotors (Forward)
        // Signal enters, gets shifted by current rotor position
        let idx = (alphabet.indexOf(char) + pos[0]) % 26;
        let forwardChar = rotorI[idx];
        
        // Signal leaves rotor, shift back for 'global' index
        let reflectedIdx = (alphabet.indexOf(forwardChar) - pos[0] + 26) % 26;
        
        // 3. Reflect
        let reflectedChar = reflectorB[reflectedIdx];
        
        // 4. Map through rotors (Reverse)
        let revInIdx = (alphabet.indexOf(reflectedChar) + pos[0]) % 26;
        let reverseChar = alphabet[rotorI.indexOf(alphabet[revInIdx])];
        let finalIdx = (alphabet.indexOf(reverseChar) - pos[0] + 26) % 26;

        return alphabet[finalIdx];
    }

    // Input Handling
    window.addEventListener('keydown', (e) => {
        const key = e.key.toUpperCase();
        if (alphabet.includes(key)) {
            // Highlight virtual key
            const el = document.getElementById(`K-${key}`);
            if(el) el.classList.add('active');

            // Encrypt and Output
            const result = enigma(key);
            document.getElementById('tape').innerText += result;
        }
    });

    window.addEventListener('keyup', (e) => {
        const key = e.key.toUpperCase();
        const el = document.getElementById(`K-${key}`);
        if(el) el.classList.remove('active');
    });

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ULTRA | ENIGMA M3 OPERATIONAL UNIT</title>
    <style>
        :root {
            --bakelite: #1a1a1a;
            --brass: #b5a642;
            --wood: #3d2b1f;
            --lamp-off: #333;
            --lamp-on: #fffbe6;
        }

        body {
            background: #0f0f0f;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            font-family: 'Courier New', Courier, monospace;
        }

        /* The Main Wooden Case */
        .enigma-machine {
            background: var(--wood);
            width: 500px;
            padding: 40px;
            border-radius: 10px;
            border: 8px solid #2a1d15;
            box-shadow: 0 50px 100px rgba(0,0,0,0.9), inset 0 0 50px rgba(0,0,0,0.5);
            position: relative;
        }

        /* Rotor Windows */
        .rotor-section {
            display: flex;
            justify-content: center;
            gap: 20px;
            background: #111;
            padding: 15px;
            border: 4px inset #333;
            margin-bottom: 30px;
        }

        .rotor-window {
            background: #eee;
            color: #000;
            width: 40px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8rem;
            font-weight: bold;
            border-radius: 3px;
            border: 2px solid #999;
        }

        /* The Lampboard (Letters that light up) */
        .lampboard {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 15px;
            margin-bottom: 40px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
        }

        .lamp {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--bakelite);
            border: 2px solid #444;
            color: #555;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            transition: 0.1s;
        }

        .lamp.active {
            background: var(--lamp-on);
            color: #000;
            box-shadow: 0 0 25px 5px white;
            border-color: #fff;
        }

        /* The Keyboard (Actual typewriter keys) */
        .keyboard {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 15px;
        }

        .key {
            width: 38px;
            height: 38px;
            background: var(--bakelite);
            border: 2px solid var(--brass);
            border-radius: 50%;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 0 #000;
            transition: 0.05s;
            user-select: none;
        }

        .key:active, .key.pressed {
            transform: translateY(4px);
            box-shadow: 0 0 0 #000;
        }

        /* Output Tape */
        .tape-feed {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            background: #d2c5a2;
            width: 90%;
            padding: 10px;
            color: #222;
            font-weight: bold;
            border-bottom: 2px dashed #999;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            overflow: hidden;
            white-space: nowrap;
        }

        /* Invisible input to catch typing */
        #hidden-input {
            position: absolute;
            opacity: 0;
        }
    </style>
</head>
<body>

    <div class="enigma-machine">
        <div class="tape-feed" id="tape">TRANSCRIPT: </div>
        
        <div class="rotor-section">
            <div class="rotor-window" id="r1">00</div>
        </div>

        <div class="lampboard" id="lampboard"></div>

        <div class="keyboard" id="keyboard"></div>

        <input type="text" id="hidden-input" autofocus>
    </div>

<script>
    const alphabet = "QWERTZUIOASDFGHJKPYXCVBNM".split(""); // German QWERTZ layout
    const rotorWiring = "EKMFLGDQVZNTOWYHXUSPAIBRCJ";
    const reflector = "YRUHQSLDPXNGOKMIEBFZCWVJAT";
    
    let rotorPos = 0;
    const lampboard = document.getElementById('lampboard');
    const keyboard = document.getElementById('keyboard');
    const tape = document.getElementById('tape');
    const r1 = document.getElementById('r1');
    const hiddenInput = document.getElementById('hidden-input');

    // Build UI
    alphabet.forEach(char => {
        const l = document.createElement('div');
        l.className = 'lamp';
        l.id = `lamp-${char}`;
        l.innerText = char;
        lampboard.appendChild(l);

        const k = document.createElement('div');
        k.className = 'key';
        k.id = `key-${char}`;
        k.innerText = char;
        keyboard.appendChild(k);
    });

    function encrypt(char) {
        let idx = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".indexOf(char);
        let shift = (idx + rotorPos) % 26;
        let forward = rotorWiring[shift];
        let refIdx = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".indexOf(forward);
        let reflected = reflector[refIdx];
        let revIdx = rotorWiring.indexOf(reflected);
        let finalIdx = (revIdx - rotorPos + 26) % 26;
        return "ABCDEFGHIJKLMNOPQRSTUVWXYZ"[finalIdx];
    }

    function handleInput(char) {
        if (!"ABCDEFGHIJKLMNOPQRSTUVWXYZ".includes(char)) return;

        // Animate key
        const keyEl = document.getElementById(`key-${char}`);
        if(keyEl) {
            keyEl.classList.add('pressed');
            setTimeout(() => keyEl.classList.remove('pressed'), 100);
        }

        const result = encrypt(char);

        // Light Lamp
        document.querySelectorAll('.lamp').forEach(l => l.classList.remove('active'));
        document.getElementById(`lamp-${result}`).classList.add('active');

        // Update Tape & Rotor
        tape.innerText += result;
        rotorPos = (rotorPos + 1) % 26;
        r1.innerText = rotorPos.toString().padStart(2, '0');
    }

    window.addEventListener('keydown', (e) => {
        const key = e.key.toUpperCase();
        if (key === "BACKSPACE") {
            tape.innerText = "TRANSCRIPT: ";
            rotorPos = 0;
            r1.innerText = "00";
        } else {
            handleInput(key);
        }
    });

    // Mobile/Click support
    keyboard.addEventListener('mousedown', (e) => {
        if(e.target.classList.contains('key')) handleInput(e.target.innerText);
    });
</script>
</body>
</html>
